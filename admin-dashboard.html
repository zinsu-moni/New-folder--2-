<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Affluence</title>
    
    <!-- API Base URL Configuration -->
    <meta name="api-base" content="https://affluence-backends-noae.vercel.app/api">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.2.0/dist/chart.min.css">
    
    <!-- Internal CSS -->
    <link rel="stylesheet" href="css/admin-shared.css">
    <link rel="stylesheet" href="css/admin-mobile.css">
    
    <style>
        /* Dashboard specific styles */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .stat-card .stat-title {
            font-size: 0.9em;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .stat-card .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 10px;
        }
        
        .stat-card .stat-icon {
            align-self: flex-end;
            font-size: 1.5em;
            color: #4f46e5;
            margin-top: -40px;
        }
        
        .stat-card .stat-change {
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-card .stat-change.positive {
            color: #10b981;
        }
        
        .stat-card .stat-change.negative {
            color: #ef4444;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .recent-activities {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: #4f46e5;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .activity-time {
            font-size: 0.8em;
            color: #6b7280;
        }
        
        .top-users-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .top-users-table th, .top-users-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .top-users-table th {
            font-weight: 600;
            color: #6b7280;
            background-color: #f9fafb;
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .loading-container i {
            font-size: 2em;
            color: #4f46e5;
        }
        
        .error-container {
            background-color: #fee2e2;
            color: #b91c1c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <i class="fas fa-gem"></i>
                    <span>Affluence</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <h3 class="nav-section-title">Main</h3>
                    <ul>
                        <li class="active">
                            <a href="admin-dashboard.html">
                                <i class="fas fa-tachometer-alt"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li>
                            <a href="admin-users.html">
                                <i class="fas fa-users"></i>
                                <span>Users</span>
                            </a>
                        </li>
                        <li>
                            <a href="admin-withdrawals.html">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Withdrawals</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <h3 class="nav-section-title">Content</h3>
                    <ul>
                        <li>
                            <a href="admin-coupons.html">
                                <i class="fas fa-ticket-alt"></i>
                                <span>Coupons</span>
                            </a>
                        </li>
                        <li>
                            <a href="admin-tasks.html">
                                <i class="fas fa-tasks"></i>
                                <span>Tasks</span>
                            </a>
                        </li>
                        <li>
                            <a href="admin-articles.html">
                                <i class="fas fa-newspaper"></i>
                                <span>Articles</span>
                            </a>
                        </li>
                        <li>
                            <a href="admin-cards.html">
                                <i class="fas fa-credit-card"></i>
                                <span>Cards</span>
                            </a>
                        </li>
                        <li>
                            <a href="admin-announcements.html">
                                <i class="fas fa-bullhorn"></i>
                                <span>Announcements</span>
                            </a>
                        </li>
                    </ul>
                </div>
                
                <div class="nav-section">
                    <h3 class="nav-section-title">System</h3>
                    <ul>
                        <li>
                            <a href="admin-logs.html">
                                <i class="fas fa-list"></i>
                                <span>System Logs</span>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Logout</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="content-area">
            <header class="content-header">
                <div class="header-title">
                    <h1>Dashboard</h1>
                    <p>Admin overview and statistics</p>
                </div>
                
                <div class="header-actions">
                    <button id="refreshBtn" class="btn btn-outline">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                    <div class="user-menu">
                        <img src="https://ui-avatars.com/api/?name=Admin&background=4F46E5&color=fff" alt="Admin" class="user-avatar">
                        <span class="user-name">Admin</span>
                    </div>
                </div>
            </header>
            
            <div class="content-body">
                <div id="dashboardContent">
                    <!-- Loading state -->
                    <div class="loading-container" id="loadingContainer">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    
                    <!-- Error state -->
                    <div class="error-container" id="errorContainer" style="display: none;">
                        <h3>Error Loading Dashboard</h3>
                        <p id="errorMessage">Failed to load dashboard data.</p>
                        <button class="btn btn-danger" onclick="loadDashboard()">Retry</button>
                    </div>
                    
                    <!-- Dashboard content (initially hidden, shown when data loads) -->
                    <div id="dashboardData" style="display: none;">
                        <!-- Stats Row -->
                        <div class="dashboard-stats" id="statsContainer">
                            <!-- Stats will be generated here -->
                        </div>
                        
                        <!-- Charts Row -->
                        <div class="chart-container">
                            <h2>User Activity Over Time</h2>
                            <canvas id="userActivityChart"></canvas>
                        </div>
                        
                        <!-- Two Column Grid -->
                        <div class="dashboard-grid">
                            <!-- Recent Activities -->
                            <div class="recent-activities">
                                <h2>Recent Activities</h2>
                                <div id="activitiesContainer">
                                    <!-- Activities will be generated here -->
                                </div>
                            </div>
                            
                            <!-- Top Users -->
                            <div class="recent-activities">
                                <h2>Top Users</h2>
                                <table class="top-users-table">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Earnings</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topUsersContainer">
                                        <!-- Top users will be generated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Include API and Admin Scripts -->
    <script src="js/api.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/admin-shared.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.0/dist/chart.umd.min.js"></script>
    
    <script>
        console.log('[admin-dashboard.js] Loading dashboard script...');
        
        // Check if API and admin API are available
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[admin-dashboard.js] DOMContentLoaded');
            console.log('[admin-dashboard.js] API available:', typeof api !== 'undefined');
            console.log('[admin-dashboard.js] Admin API available:', typeof adminAPI !== 'undefined');
            
            // Setup mobile menu toggle
            setupMobileMenu();
            
            if (typeof api === 'undefined' || typeof adminAPI === 'undefined') {
                showError('API or Admin API not available. Check that js/api.js and js/admin.js are loaded correctly.');
                return;
            }
            
            // Verify authentication
            if (!api.isAuthenticated()) {
                console.error('[admin-dashboard.js] Not authenticated, redirecting to login');
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Load dashboard data
            loadDashboard();
        });
        
        // Setup mobile menu toggle
        function setupMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');
            
            if (!mobileMenuBtn || !sidebar || !mobileOverlay) {
                console.warn('[admin-dashboard.js] Mobile menu elements not found');
                return;
            }
            
            // Toggle sidebar
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                mobileOverlay.classList.toggle('active');
            });
            
            // Close sidebar when clicking overlay
            mobileOverlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                mobileOverlay.classList.remove('active');
            });
            
            // Close sidebar when clicking nav links on mobile
            const navLinks = sidebar.querySelectorAll('a');
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (window.innerWidth <= 1024) {
                        sidebar.classList.remove('active');
                        mobileOverlay.classList.remove('active');
                    }
                });
            });
        }
        
        // Load dashboard data from API
        async function loadDashboard() {
            console.log('[admin-dashboard.js] Loading dashboard data...');
            
            // Show loading state
            document.getElementById('loadingContainer').style.display = 'flex';
            document.getElementById('dashboardData').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'none';
            
            try {
                // Fetch dashboard data
                const dashboardData = await adminAPI.getDashboard();
                console.log('[admin-dashboard.js] Dashboard data:', dashboardData);
                
                // Render dashboard components
                renderStats(dashboardData);
                renderChart(dashboardData);
                renderActivities(dashboardData.recent_activities || []);
                renderTopUsers(dashboardData.top_users || []);
                
                // Show dashboard data
                document.getElementById('loadingContainer').style.display = 'none';
                document.getElementById('dashboardData').style.display = 'block';
            } catch (error) {
                console.error('[admin-dashboard.js] Error loading dashboard:', error);
                showError(error.message || 'Failed to load dashboard data');
            }
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        // Render statistics cards
        function renderStats(data) {
            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = '';
            
            // Define stats to display
            const stats = [
                {
                    title: 'Total Users',
                    value: data.total_users || 0,
                    icon: 'fas fa-users',
                    change: data.users_change || 0
                },
                {
                    title: 'Active Users',
                    value: data.active_users || 0,
                    icon: 'fas fa-user-check',
                    change: data.active_users_change || 0
                },
                {
                    title: 'Total Earnings',
                    value: formatCurrency(data.total_earnings || 0),
                    icon: 'fas fa-money-bill-wave',
                    change: data.earnings_change || 0
                },
                {
                    title: 'Pending Withdrawals',
                    value: data.pending_withdrawals || 0,
                    icon: 'fas fa-clock',
                    change: data.withdrawals_change || 0
                }
            ];
            
            // Create stat cards
            stats.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                
                const changeClass = stat.change >= 0 ? 'positive' : 'negative';
                const changeIcon = stat.change >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                card.innerHTML = `
                    <div class="stat-title">${stat.title}</div>
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-icon"><i class="${stat.icon}"></i></div>
                    <div class="stat-change ${changeClass}">
                        <i class="fas ${changeIcon}"></i>
                        ${Math.abs(stat.change)}% since last week
                    </div>
                `;
                
                statsContainer.appendChild(card);
            });
        }
        
        // Render user activity chart
        function renderChart(data) {
            const ctx = document.getElementById('userActivityChart').getContext('2d');
            
            // Use data from API or fallback to sample data
            const chartData = data.user_activity_data || {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                data: [30, 45, 60, 70, 65, 80]
            };
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Active Users',
                        data: chartData.data,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Render recent activities
        function renderActivities(activities) {
            const container = document.getElementById('activitiesContainer');
            container.innerHTML = '';
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<p>No recent activities</p>';
                return;
            }
            
            activities.slice(0, 5).forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                
                // Determine icon based on activity type
                let icon = 'fa-bell';
                if (activity.type === 'login') icon = 'fa-sign-in-alt';
                if (activity.type === 'withdrawal') icon = 'fa-money-bill-wave';
                if (activity.type === 'registration') icon = 'fa-user-plus';
                if (activity.type === 'purchase') icon = 'fa-shopping-cart';
                
                activityItem.innerHTML = `
                    <div class="activity-icon">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.message}</div>
                        <div class="activity-time">${formatTimeAgo(activity.timestamp)}</div>
                    </div>
                `;
                
                container.appendChild(activityItem);
            });
        }
        
        // Render top users table
        function renderTopUsers(users) {
            const container = document.getElementById('topUsersContainer');
            container.innerHTML = '';
            
            if (!users || users.length === 0) {
                container.innerHTML = '<tr><td colspan="3">No users found</td></tr>';
                return;
            }
            
            users.slice(0, 5).forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center;">
                            <img src="https://ui-avatars.com/api/?name=${user.username || 'User'}&background=4F46E5&color=fff" class="user-avatar">
                            ${user.username || 'Anonymous'}
                        </div>
                    </td>
                    <td>${formatCurrency(user.earnings || 0)}</td>
                    <td>
                        <span class="badge ${user.is_active ? 'badge-success' : 'badge-danger'}">
                            ${user.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                `;
                
                container.appendChild(row);
            });
        }
        
        // Helper function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-NG', {
                style: 'currency',
                currency: 'NGN',
                minimumFractionDigits: 0
            }).format(amount).replace('NGN', '₦');
        }
        
        // Helper function to format time ago
        function formatTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if (diffDay > 0) return `${diffDay} day${diffDay > 1 ? 's' : ''} ago`;
            if (diffHour > 0) return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
            if (diffMin > 0) return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
            return `${diffSec} second${diffSec !== 1 ? 's' : ''} ago`;
        }
        
        // Handle refresh button click
        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadDashboard();
        });
        
        // Handle logout button click
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            api.removeToken();
            window.location.href = 'admin-login.html';
        });
    </script>
    
    <!-- API Connection Monitor Script -->
    <script>
        // Check API connection periodically
        function checkApiConnection() {
            if (!api) {
                console.error('[admin-dashboard.js] API object not available!');
                showConnectionError('API object not available');
                return;
            }
            
            // Test API connection
            fetch(api.baseURL + '/admin/dashboard', {
                headers: {
                    'Authorization': `Bearer ${api.getToken()}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('[admin-dashboard.js] API test connection status:', response.status);
                if (!response.ok) {
                    showConnectionError(`API returned status ${response.status}`);
                } else {
                    hideConnectionError();
                }
                return response.json();
            })
            .catch(error => {
                console.error('[admin-dashboard.js] API connection test failed:', error);
                showConnectionError(`Connection failed: ${error.message}`);
            });
        }
        
        // Show connection error
        function showConnectionError(message) {
            let errorEl = document.getElementById('api-connection-error');
            if (!errorEl) {
                errorEl = document.createElement('div');
                errorEl.id = 'api-connection-error';
                errorEl.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background-color: #fee2e2;
                    color: #b91c1c;
                    padding: 10px 20px;
                    text-align: center;
                    z-index: 9999;
                    font-weight: bold;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                `;
                document.body.appendChild(errorEl);
            }
            
            errorEl.innerHTML = `
                ⚠️ Backend connection issue: ${message}
                <button onclick="location.reload()" style="margin-left: 15px; padding: 3px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Reload
                </button>
                <a href="api-diagnostic.html" style="margin-left: 10px; color: #b91c1c; text-decoration: underline;">
                    Run Diagnostics
                </a>
            `;
        }
        
        // Hide connection error
        function hideConnectionError() {
            const errorEl = document.getElementById('api-connection-error');
            if (errorEl) {
                errorEl.style.display = 'none';
            }
        }
        
        // Check connection when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkApiConnection, 1000);
        });
    </script>
</body>
</html>