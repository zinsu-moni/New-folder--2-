<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupon Management - Affluence Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin-shared.css">
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <i class="fas fa-gem"></i>
                    <span>Affluence</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="admin-dashboard.html" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="admin-users.html" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>Users</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a href="admin-tasks.html" class="nav-item">
                        <i class="fas fa-tasks"></i>
                        <span>Tasks</span>
                    </a>
                    <a href="admin-coupons.html" class="nav-item active">
                        <i class="fas fa-ticket-alt"></i>
                        <span>Coupons</span>
                    </a>
                    <a href="admin-withdrawals.html" class="nav-item">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Withdrawals</span>
                    </a>
                    <a href="admin-streaming.html" class="nav-item">
                        <i class="fas fa-video"></i>
                        <span>Streaming</span>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <a href="admin-announcements.html" class="nav-item">
                        <i class="fas fa-bullhorn"></i>
                        <span>Announcements</span>
                    </a>
                    <a href="admin-logs.html" class="nav-item">
                        <i class="fas fa-clipboard-list"></i>
                        <span>System Logs</span>
                    </a>
                    <a href="vendor-lounge.html" class="nav-item" id="vendorMenuItem" style="display: none;">
                        <i class="fas fa-store"></i>
                        <span>Vendor Lounge</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div class="header-top">
                    <h1 class="page-title">Coupon Management</h1>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="createCouponModal()">
                            <i class="fas fa-plus"></i>
                            <span>Create Coupon</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">Filter Coupons</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Status</label>
                        <select id="statusFilter" onchange="loadCoupons()" class="form-control">
                            <option value="">All Status</option>
                            <option value="unused">Unused</option>
                            <option value="used">Used</option>
                            <option value="revoked">Revoked</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Type</label>
                        <select id="typeFilter" onchange="loadCoupons()" class="form-control">
                            <option value="">All Types</option>
                            <option value="mega">Mega</option>
                            <option value="alpha">Alpha</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Search</label>
                        <input type="text" id="searchFilter" class="form-control" placeholder="Search by code or username..." onkeyup="loadCoupons()">
                    </div>
                </div>
            </div>

            <!-- Coupons Table -->
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">All Coupons</h2>
                    <span id="couponCount" style="color: var(--text-light); font-size: 14px;">Loading...</span>
                </div>

                <div class="table-container">
                    <table id="couponsTable">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="couponsTableBody">
                            <tr>
                                <td colspan="6">
                                    <div class="loading">
                                        <div class="spinner"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Coupon Modal -->
    <div id="createCouponModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Coupon</h3>
                <button class="modal-close" onclick="closeModal('createCouponModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createCouponForm">
                    <div class="form-group">
                        <label class="form-label">Coupon Code</label>
                        <input type="text" id="couponCode" class="form-control" required placeholder="Enter unique coupon code">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Coupon Type</label>
                        <select id="couponType" class="form-control" required>
                            <option value="">Select type...</option>
                            <option value="mega">Mega</option>
                            <option value="alpha">Alpha</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="couponQuantity" class="form-control" min="1" value="1" placeholder="Number of coupons">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('createCouponModal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleCreateCoupon()">Create Coupon</button>
            </div>
        </div>
    </div>

    <!-- Assign Coupon Modal -->
    <div id="assignCouponModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Assign Coupon</h3>
                <button class="modal-close" onclick="closeModal('assignCouponModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="assignCouponForm">
                    <input type="hidden" id="assignCouponId">
                    <div class="form-group">
                        <label class="form-label">Coupon Code</label>
                        <input type="text" id="assignCouponCode" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Select User</label>
                        <select id="assignUserId" class="form-control" required>
                            <option value="">Loading users...</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('assignCouponModal')">Cancel</button>
                <button class="btn btn-primary" onclick="handleAssignCoupon()">Assign</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="js/api.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/admin-shared.js"></script>
    <script>
        // Fallback shim: ensure adminAPI exists
        (function ensureAdminAPI() {
            if (typeof window.adminAPI === 'undefined') {
                try {
                    const apiInst = window.api || new AffluenceAPI();
                    window.adminAPI = {
                        getUsers: async (skip = 0, limit = 100, role = null) => {
                            let url = `/admin/users?skip=${skip}&limit=${limit}`;
                            if (role) url += `&role=${role}`;
                            return await apiInst.get(url);
                        },
                        getCoupons: async (skip = 0, limit = 100, status = null) => {
                            let url = `/admin/coupons?skip=${skip}&limit=${limit}`;
                            if (status) url += `&status=${status}`;
                            return await apiInst.get(url);
                        },
                        createCoupon: async (data) => apiInst.post('/admin/coupons', data),
                        updateCoupon: async (id, data) => apiInst.put(`/admin/coupons/${id}`, data),
                        deleteCoupon: async (id) => apiInst.delete(`/admin/coupons/${id}`)
                    };
                    console.warn('adminAPI was missing; fallback shim initialized.');
                } catch (e) {
                    console.error('Failed to initialize adminAPI shim:', e);
                }
            }
        })();

        let allCoupons = [];

        async function loadCoupons() {
            try {
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter')?.value || '';
                const searchFilter = document.getElementById('searchFilter')?.value.toLowerCase() || '';

                const response = await adminAPI.getCoupons(0, 1000, statusFilter || null);
                allCoupons = response.coupons || response;

                // Apply additional filters
                let filteredCoupons = allCoupons;

                if (typeFilter) {
                    filteredCoupons = filteredCoupons.filter(c => c.coupon_type === typeFilter);
                }

                if (searchFilter) {
                    filteredCoupons = filteredCoupons.filter(c => 
                        c.code.toLowerCase().includes(searchFilter) ||
                        (c.assigned_username && c.assigned_username.toLowerCase().includes(searchFilter))
                    );
                }

                updateStats(allCoupons);
                renderCouponsTable(filteredCoupons);
            } catch (error) {
                console.error('Error loading coupons:', error);
                showToast('Failed to load coupons: ' + error.message, 'error');
                document.getElementById('couponsTable').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Failed to load coupons: ${error.message}</p>
                    </div>
                `;
            }
        }

        function updateStats(coupons) {
            document.getElementById('totalCoupons').textContent = coupons.length;
            document.getElementById('unusedCoupons').textContent = coupons.filter(c => c.status === 'unused').length;
            document.getElementById('usedCoupons').textContent = coupons.filter(c => c.status === 'used').length;
            document.getElementById('revokedCoupons').textContent = coupons.filter(c => c.status === 'revoked').length;
        }

        function renderCouponsTable(coupons) {
                const tbody = document.getElementById('couponsTableBody');
                document.getElementById('couponCount').textContent = `${coupons.length} coupon(s)`;
            
            if (coupons.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-light);">
                                <i class="fas fa-ticket-alt" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                                No coupons found
                            </td>
                        </tr>
                    `;
                return;
            }

                tbody.innerHTML = coupons.map(coupon => `
                    <tr>
                        <td>
                            <strong style="font-family: monospace; color: var(--primary);">
                                ${coupon.code}
                            </strong>
                        </td>
                        <td>
                            <span class="badge ${coupon.coupon_type === 'mega' ? 'badge-warning' : 'badge-info'}">
                                ${coupon.coupon_type === 'mega' ? '💎 Mega' : '🌟 Alpha'}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(coupon.status)}">
                                ${coupon.status}
                            </span>
                        </td>
                        <td>
                            ${coupon.assigned_username 
                                ? `<span><i class="fas fa-user"></i> ${coupon.assigned_username}</span>`
                                : '<span style="color: var(--text-light);"><i class="fas fa-minus"></i> Unassigned</span>'
                            }
                        </td>
                        <td style="color: var(--text-light); font-size: 14px;">
                            ${new Date(coupon.created_at).toLocaleString()}
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                ${coupon.status === 'unused' && !coupon.assigned_user_id
                                    ? `<button class="btn-icon btn-primary" onclick="openAssignModal(${coupon.id}, '${coupon.code}')" title="Assign">
                                        <i class="fas fa-user-plus"></i>
                                    </button>`
                                    : ''
                                }
                                ${coupon.status === 'unused'
                                    ? `<button class="btn-icon btn-warning" onclick="revokeCoupon(${coupon.id})" title="Revoke">
                                        <i class="fas fa-ban"></i>
                                    </button>`
                                    : ''
                                }
                                <button class="btn-icon btn-danger" onclick="deleteCoupon(${coupon.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'unused': return 'badge-success';
                case 'used': return 'badge-info';
                case 'revoked': return 'badge-danger';
                default: return 'badge-secondary';
            }
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'unused': return '<i class="fas fa-check-circle"></i>';
                case 'used': return '<i class="fas fa-user-check"></i>';
                case 'revoked': return '<i class="fas fa-ban"></i>';
                default: return '<i class="fas fa-question-circle"></i>';
            }
        }

        function createCouponModal() {
            document.getElementById('createCouponForm').reset();
            openModal('createCouponModal');
        }

        async function handleCreateCoupon(event) {
              if (event) event.preventDefault();

            const code = document.getElementById('couponCode').value.trim();
            const type = document.getElementById('couponType').value;
            const quantity = parseInt(document.getElementById('couponQuantity').value) || 1;

            try {
                if (quantity === 1) {
                    await adminAPI.createCoupon({ code, coupon_type: type });
                    showToast('Coupon created successfully!', 'success');
                } else {
                    // Create multiple coupons
                    for (let i = 0; i < quantity; i++) {
                        const randomCode = code + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                        await adminAPI.createCoupon({ code: randomCode, coupon_type: type });
                    }
                    showToast(`${quantity} coupons created successfully!`, 'success');
                }

                closeModal('createCouponModal');
                loadCoupons();
            } catch (error) {
                console.error('Error creating coupon:', error);
                showToast('Failed to create coupon: ' + error.message, 'error');
            }
        }

        async function openAssignModal(couponId, code) {
            document.getElementById('assignCouponId').value = couponId;
            document.getElementById('assignCouponCode').value = code;

            // Load users
            try {
                const response = await adminAPI.getUsers(0, 1000);
                const users = response.users || response;
                
                const userSelect = document.getElementById('assignUserId');
                userSelect.innerHTML = '<option value="">Select a user...</option>' +
                    users.map(user => `<option value="${user.id}">${user.username} (${user.email})</option>`).join('');

                openModal('assignCouponModal');
            } catch (error) {
                showToast('Failed to load users: ' + error.message, 'error');
            }
        }

        async function handleAssignCoupon(event) {
              if (event) event.preventDefault();

            const couponId = document.getElementById('assignCouponId').value;
            const userId = document.getElementById('assignUserId').value;

            try {
                await adminAPI.updateCoupon(couponId, { 
                    assigned_user_id: parseInt(userId),
                    status: 'unused'
                });

                showToast('Coupon assigned successfully!', 'success');
                closeModal('assignCouponModal');
                loadCoupons();
            } catch (error) {
                console.error('Error assigning coupon:', error);
                showToast('Failed to assign coupon: ' + error.message, 'error');
            }
        }

        async function revokeCoupon(couponId) {
            if (!confirm('Are you sure you want to revoke this coupon?')) return;

            try {
                await adminAPI.updateCoupon(couponId, { status: 'revoked' });
                showToast('Coupon revoked successfully!', 'success');
                loadCoupons();
            } catch (error) {
                console.error('Error revoking coupon:', error);
                showToast('Failed to revoke coupon: ' + error.message, 'error');
            }
        }

        async function deleteCoupon(couponId) {
            if (!confirm('Are you sure you want to delete this coupon? This action cannot be undone.')) return;

            try {
                await adminAPI.deleteCoupon(couponId);
                showToast('Coupon deleted successfully!', 'success');
                loadCoupons();
            } catch (error) {
                console.error('Error deleting coupon:', error);
                showToast('Failed to delete coupon: ' + error.message, 'error');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            initAdminUI();
            loadCoupons();
        });
    </script>
</body>
</html>
